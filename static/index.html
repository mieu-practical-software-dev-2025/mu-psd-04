<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sample Application</title>
    <!-- Vue.jsをCDNから読み込み -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- BootStrapをCDNから読み込み -->
	<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
</head>
<body>

    <div id="app" class="container">
        <h2 class="my-4 text-center">アキネーター風アプリ v1.2</h2>

        <!-- スタート画面 (isGameStartedがfalseの場合に表示) -->
        <div v-if="!isGameStarted" class="text-center mt-5">
            <div class="card shadow-sm p-4">
                <div class="card-body">
                    <h3 class="card-title">魔人の質問</h3>
                    <p class="lead my-4">頭の中に、実在または架空の人物・キャラクターを思い浮かべてください。<br>いくつかの質問に答えるだけで、私が当ててみせましょう。</p>
                    <button @click="startGame" class="btn btn-primary btn-lg">ゲームを開始する</button>
                </div>
            </div>
        </div>

        <!-- ゲーム画面 (isGameStartedがtrueの場合に表示) -->
        <div v-else>
            <div class="card shadow-sm">
                <div class="card-header">
                    質問 {{ questionCount }}
                </div>
                <div class="card-body text-center" style="min-height: 250px;">
                    <div v-if="!isFinished">
                        <div style="min-height: 120px;">
                            <p class="lead my-4" style="min-height: 50px;">{{ currentQuestion }}</p>
                            <div v-if="isLoading" class="d-flex justify-content-center my-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">考え中...</span>
                                </div>
                            </div>
                            <div v-else>
                                <!-- 回答ボタンを囲む枠 -->
                                <div class="border rounded p-3 my-3">
                                    <div class="mb-2">
                                        <button @click="answer('はい')" class="btn btn-primary btn-lg m-2 px-4">はい</button>
                                        <button @click="answer('いいえ')" class="btn btn-danger btn-lg m-2 px-4">いいえ</button>
                                        <button @click="answer('わからない')" class="btn btn-secondary btn-lg m-2">わからない</button>
                                    </div>
                                    <div>
                                        <button @click="answer('たぶんそう')" class="btn btn-info m-2">たぶんそう</button>
                                        <button @click="answer('部分的に違う')" class="btn btn-warning m-2">部分的に違う</button>
                                    </div>
                                </div>
                            </div>
                            <button v-if="history.length > 0 && !isLoading" @click="undo" class="btn btn-link text-secondary mt-3">一つ前の質問に戻る</button>
                        </div>
                    </div>
                    <div v-else>
                        <p class="lead my-4">あなたの思い浮かべているのは...</p>
                        <h3 class="card-title mb-4">{{ finalAnswer.replace('あなたの思い浮かべているのは', '').replace('ですね！', '') }}</h3>
                        
                        <div v-if="userFeedback === null">
                            <p>この答えは合っていますか？</p>
                            <button @click="handleFeedback(true)" class="btn btn-success btn-lg m-2">正解！</button>
                            <button @click="handleFeedback(false)" class="btn btn-danger btn-lg m-2">不正解...</button>
                        </div>
                        <div v-else-if="userFeedback === true" class="mt-4">
                            <button @click="resetGame" class="btn btn-primary btn-lg">もう一度遊ぶ</button>
                        </div>
                        <div v-else-if="userFeedback === false" class="mt-4">
                            <p>ゲームを続けますか？</p>
                            <button @click="continueGame" class="btn btn-info btn-lg m-2">質問を続ける</button>
                            <button @click="resetGame" class="btn btn-secondary btn-lg m-2">最初から</button>
                        </div>
                    </div>
                     <div v-if="error" class="alert alert-danger mt-4">{{ error }}</div>
                </div>
            </div>

            <div class="mt-4" v-if="history.length > 0">
                <h5>回答履歴</h5>
                <ul class="list-group">
                    <li v-for="(item, index) in history" :key="index" class="list-group-item list-group-item-light">
                        <small><strong>Q:</strong> {{ item.q }} <br> <strong>A:</strong> {{ item.a }}</small>
                    </li>
                </ul>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // ゲームの状態を管理する変数
                    history: [],
                    currentQuestion: '',
                    finalAnswer: '',
                    isLoading: false,
                    isFinished: false,
                    isGameStarted: false,
                    error: '',
                    userFeedback: null, // null, true (correct), or false (incorrect)
                };
            },
            computed: {
                questionCount() {
                    return this.history.length + 1;
                }
            },
            methods: {
                async fetchNext(userAnswer = null) {
                    this.isLoading = true;
                    this.error = '';

                    if (userAnswer) {
                        this.history.push({ q: this.currentQuestion, a: userAnswer });
                    }

                    try {
                        const response = await fetch('/akinator_api', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ history: this.history })
                        });
                        const data = await response.json();

                        if (response.ok) {
                            if (data.type === 'question') {
                                this.currentQuestion = data.text;
                            } else if (data.type === 'answer') {
                                this.finalAnswer = data.text;
                                this.isFinished = true;
                                this.userFeedback = null; // Reset feedback state
                            }
                        } else {
                            this.error = `エラー: ${data.error || '不明なエラー'}`;
                        }
                    } catch (error) {
                        this.error = `通信エラー: ${error.message}`;
                    } finally {
                        this.isLoading = false;
                    }
                },
                answer(userAnswer) {
                    this.fetchNext(userAnswer);
                },
                async undo() {
                    if (this.history.length === 0) return;

                    this.isLoading = true;
                    this.error = '';
                    this.isFinished = false;
                    this.finalAnswer = '';

                    try {
                        const response = await fetch('/undo_api', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ history: this.history })
                        });
                        const data = await response.json();

                        if (response.ok) {
                            // 戻る前の回答を履歴から削除
                            this.history.pop();
                            // AIから返ってきた質問（＝一つ前の質問）を再設定
                            this.currentQuestion = data.text;
                        } else {
                            this.error = `エラー: ${data.error || '不明なエラー'}`;
                        }
                    } catch (error) {
                        this.error = `通信エラー: ${error.message}`;
                    } finally {
                        this.isLoading = false;
                    }
                },
                startGame() {
                    this.isGameStarted = true;
                    this.fetchNext(); // ゲーム開始時に最初の質問を取得
                },
                resetGame() {
                    // isGameStarted以外を初期化してスタート画面に戻す
                    Object.assign(this.$data, this.$options.data.apply(this));
                },
                handleFeedback(isCorrect) {
                    this.userFeedback = isCorrect;
                },
                continueGame() {
                    // AIの答えが間違いだったことを履歴に追加
                    const failedAnswer = this.finalAnswer.replace('あなたの思い浮かべているのは', '').replace('ですね！', '');
                    this.history.push({ q: `それは「${failedAnswer}」ですか？`, a: 'いいえ' });
                    this.isFinished = false;
                    this.finalAnswer = '';
                    this.fetchNext(); // 新しい質問を取得
                }
            },
            // mountedフックは不要になるため削除
        }).mount('#app');
    </script>
</body>
</html>