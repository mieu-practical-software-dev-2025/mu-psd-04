<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>冷蔵庫レシピ提案アプリ</title>
    <!-- Vue.jsをCDNから読み込み -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- BootStrapをCDNから読み込み -->
	<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
</head>
<body>
    <div id="app" class="container">
        <h2 class="mb-4">冷蔵庫レシピ提案アプリ</h2>

        <div class="mb-3">
            <label for="inputText" class="form-label">冷蔵庫にある食材を入力してください:</label>
            <textarea id="inputText" class="form-control" rows="5" v-model="inputText" placeholder="例：豚肉、玉ねぎ、じゃがいも、にんじん"></textarea>
        </div>

        <div class="mb-3">
            <button @click="execute" class="btn btn-primary">レシピを考える</button>
        </div>
        
        <!-- 結果表示エリア -->
        <div v-if="resultText">
            <h3>結果:</h3>
            <div class="result-area p-3 border rounded" :class="{ 'alert alert-info': !isError, 'alert alert-danger': isError }">
                <pre style="white-space: pre-wrap;">{{ resultText }}</pre>
            </div>

            <!-- 別の料理提案ボタンとリスト -->
            <div class="mt-3" v-if="!isError && firstRequestDone">
                <button @click="getOtherSuggestions" class="btn btn-secondary" v-if="!otherSuggestions.length">別の料理を提案</button>
                <div v-if="otherSuggestions.length" class="mt-2">
                    <p>こちらの料理はいかがですか？</p>
                    <button v-for="suggestion in otherSuggestions" :key="suggestion" @click="getSpecificRecipe(suggestion)" class="btn btn-outline-success me-2 mb-2">{{ suggestion }}</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    inputText: '',
                    resultText: 'ここに結果が表示されます。', // 初期状態は空にする
                    isError: false,
                    firstRequestDone: false, // 最初のレシピ検索が完了したか
                    otherSuggestions: [], // 他に提案された料理リスト
                };
            },
            methods: {
                async sendRequest(prompt, context = null) {
                    this.resultText = '処理中...';
                    this.isError = false;

                    try {
                        // APIに送るデータをpayloadとしてまとめる
                        const payload = { text: prompt };
                        if (context) {
                            payload.context = context;
                        }

                        const response = await fetch('/send_api', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload)
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.resultText = data.processed_text;
                            this.isError = false;
                        } else {
                            this.resultText = `エラー: ${data.error || '不明なエラーが発生しました。'}`;
                            this.isError = true;
                        }
                    } catch (error) {
                        this.resultText = `エラー: ${error.message || '通信に失敗しました。'}`;
                        this.isError = true;
                    }
                },
                execute() {
                    if (!this.inputText.trim()) {
                        this.resultText = 'エラー：食材を入力してください。';
                        this.isError = true;
                        return;
                    }
                    this.firstRequestDone = true;
                    this.otherSuggestions = []; // 新しい検索なのでリセット
                    this.sendRequest(this.inputText);
                },
                async getOtherSuggestions() {
                    const prompt = `「${this.inputText}」を使って作れる、今表示している料理以外の料理名を5つ、箇条書きで料理名だけ挙げてください。`;
                    const context = "ユーザーに料理名のリストを提示します。余計な説明はつけず、料理名だけを箇条書き（例: `- 料理名`）で出力してください。";
                    await this.sendRequest(prompt, context);
                    
                    // 結果をパースしてリストにする
                    if (!this.isError) {
                        this.otherSuggestions = this.resultText.split('\n').map(s => s.replace(/[-*・ ]/g, '').trim()).filter(s => s);
                        this.resultText = "こちらの料理はいかがですか？下から選んでください。";
                    }
                },
                getSpecificRecipe(dishName) {
                    const prompt = `「${this.inputText}」を使って「${dishName}」を作るためのレシピを教えてください。`;
                    this.otherSuggestions = []; // レシピ表示時に候補リストは非表示にする
                    this.sendRequest(prompt);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>