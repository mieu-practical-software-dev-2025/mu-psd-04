# Webアプリ仕様書

## 1. 概要

本アプリケーションは、AIとの対話を通じてユーザーが頭に思い浮かべた人物やキャラクターを当てる、いわゆる「アキネーター」風のWebゲームです。
ユーザーはAIからの質問に対し、5つの選択肢（「はい」「いいえ」「わからない」「たぶんそう」「部分的に違う」）で回答します。AIはこれらの回答を蓄積・分析し、候補を絞り込みながら質問を続け、最終的に一つの答えを推測して提示します。

## 2. 主な機能

### 2.1 ゲーム進行機能
ユーザーがゲームを開始してから終了するまでの一連のフローを管理します。

- **ゲーム開始**: スタート画面のボタン押下により、ゲーム画面へ遷移し、AIが最初の質問を生成します。
- **質問と回答**:
  - AIが生成した質問が画面に表示されます。
  - ユーザーは5つの選択肢（はい, いいえ, わからない, たぶんそう, 部分的に違う）から1つを選んで回答します。
  - 回答は履歴として画面下部に蓄積されます。
- **最終回答の提示**: AIが候補を十分に絞り込めたと判断した場合、質問の代わりに最終的な回答（例：「あなたの思い浮かべているのは「〇〇」ですね！」）を提示します。
- **回答の巻き戻し**: ユーザーが直前の回答を間違えた場合、「一つ前の質問に戻る」機能を使って、一つ前の状態に復帰できます。

### 2.2 ユーザーフィードバック機能
AIが最終回答を提示した後、その推測が正しかったかどうかをユーザーがフィードバックする機能です。

- **正解の場合**: ユーザーが「正解！」ボタンを押すと、ゲーム終了となり、「もう一度遊ぶ」ボタンが表示されます。
- **不正解の場合**: ユーザーが「不正解...」ボタンを押すと、「質問を続ける」か「最初から」を選択できます。
  - 「質問を続ける」を選択した場合、AIの回答が間違いであったことが履歴に追加され、AIは新たな質問を生成します。

### 2.2 生成AIリクエスト API
バックエンドは、フロントエンドからのリクエストに応じてAIとの通信を仲介するAPIを提供します。

- **`/akinator_api`**:
  - **役割**: 次の質問、または最終回答を生成します。
  - **入力**: フロントエンドから送信された、過去の質問と回答の全履歴（JSON形式）。
  - **処理**: 受け取った履歴を元に、AIに対して次のアクションを指示するプロンプトを構築し、OpenRouter APIへリクエストを送信します。
  - **出力**: AIの応答を解析し、`{"type": "question", ...}` または `{"type": "answer", ...}` の形式でフロントエンドに返却します。
- **`/undo_api`**:
  - **役割**: 一つ前の質問を再生成します。
  - **入力**: フロントエンドから送信された、現在の全履歴（JSON形式）。
  - **処理**: 履歴の最後の1件を削除し、その状態を元にAIに対して「もう一度同じ質問をする」よう指示するプロンプトを構築し、リクエストを送信します。
  - **出力**: 再生成された質問を `{"type": "question", ...}` の形式で返却します。

## 3. 画面設計

### 3.1 スタート画面
- アプリケーションのタイトル、簡単な説明、および「ゲームを開始する」ボタンを配置します。

### 3.2 ゲーム画面
- **質問表示エリア**: AIからの現在の質問を表示します。
- **回答ボタンエリア**: 5つの回答選択肢ボタンと、「一つ前の質問に戻る」ボタンを配置します。
- **回答履歴エリア**: これまでの質問と回答のペアをリスト形式で表示します。

### 3.3 結果表示画面
- AIの最終回答が表示された後、UIが切り替わります。
- AIの推測した答えと、それに対するフィードバック（「正解！」「不正解...」）ボタンが表示されます。
- フィードバックの結果に応じて、さらに「もう一度遊ぶ」や「質問を続ける」などのボタンが表示されます。

## 3. 使用技術

| 分類         | 技術・ライブラリ |
|--------------|------------------|
| フロントエンド | Vue.js (CDN) / HTML5 + CSS3 (Bootstrap) | シングルファイルのコンポーネント構成。 |
| バックエンド  | Flask (Python) | APIサーバーとして機能。 |
| 通信方式     | Fetch API / JSON | 非同期通信によるスムーズなUI更新を実現。 |
| LLMプロキシ    | OpenRouter API | 複数のLLMモデル（GPT-4o-mini等）を柔軟に利用。 |

## 4. 入出力例

### 入力
- ユーザーが「かぐや姫」を想定している場合の対話履歴
```json
{
  "history": [
    {"q": "そのキャラクターは女性ですか？", "a": "はい"},
    {"q": "そのキャラクターは物語の登場人物ですか？", "a": "はい"},
    {"q": "そのキャラクターは日本の物語に登場しますか？", "a": "はい"}
  ]
}
```

### 出力

- 出力例（次の質問）:
```json
{
  "type": "question",
  "text": "そのキャラクターは竹の中から生まれましたか？"
}
```

- 出力例（最終回答）:
```json
{
  "type": "answer",
  "text": "あなたの思い浮かべているキャラクターは「かぐや姫」ですね！"
}
```